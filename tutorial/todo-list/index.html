<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Todo list tutorial - Light Eventuate 4J - An event sourcing and CQRS framework with Kafka</title>
    <meta name="generator" content="Hugo 0.20.6" />

    
    <meta name="description" content="Light Eventuate Docs">
    
    <link rel="canonical" href="https://networknt.github.io/light-eventuate-4j/tutorial/todo-list/">
    
    <meta name="author" content="Steve Hu, Gavin Chen">
    

    <meta property="og:url" content="https://networknt.github.io/light-eventuate-4j/tutorial/todo-list/">
    <meta property="og:title" content="Light Eventuate 4J - An event sourcing and CQRS framework with Kafka">
    <meta property="og:image" content="https://networknt.github.io/light-eventuate-4j/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Eventuate 4J - An event sourcing and CQRS framework with Kafka">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/light-eventuate-4j/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/light-eventuate-4j/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/light-eventuate-4j/fonts/icon.eot');
        src: url('https://networknt.github.io/light-eventuate-4j/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/light-eventuate-4j/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Todo list tutorial
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-eventuate-4j" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/light-eventuate-4jimages/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Eventuate 4J - An event sourcing and CQRS framework with Kafka <span class="version">1.3.4</span></strong>
        
          <br>
          networknt/light-eventuate-4j
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-eventuate-4j/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-eventuate-4j/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/light-eventuate-4j/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/light-eventuate-4j/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/light-eventuate-4j/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Component" href="https://networknt.github.io/light-eventuate-4j/component/">
	
	Component
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/light-eventuate-4j/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/light-eventuate-4j/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-eventuate/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/light-eventuate-4j/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/light-eventuate-4j/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Todo list tutorial </h1>

			

<p>This is the most simple Hello World type of application with event sourcing
and CQRS on top of light-eventuate-4j. It has command side service that add
new todo item, update existing todo item and remove todo item(s). It also
has query side service to retrieve all the todo items for display in the web
single page application.</p>

<p>The following steps will assume you know the basic about light-eventuate-4j
as well as light-rest-4j and light-hybrid-4j as we are going to build services
in RESTful style and Hybrid style.</p>

<p>Before starting any service, we need to make sure that light-eventuate-4j is
up and running. Please follow this <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/">tutorial</a>
to set up.</p>

<p>We are going to implement the application in both light-rest-4j and light-hybrid-4
and the two implementations will be sitting in the same folders in light-example-4j.</p>

<p>As the todo-list folder already in the public repo of light-example-4j/eventuate, we
are going to rename the existing project and you can compare these folders if you want.</p>

<h2 id="prepare-environment">Prepare environment</h2>

<p>Assuming that light-eventuate-4j platform is up and running, let&rsquo;s checkout the
light-example-4j project and rename todo-list folder in eventuate so that we can
recreate it in this tutorial.</p>

<p>As other tutorials, we are going to use networknt under user&rsquo;s home directory as
workspace.</p>

<pre><code class="language-$xslt">cd ~/networknt
git clone git@github.com:networknt/light-example-4j.git
cd light-example-4j/eventuate
mv todo-list todo-list.bak
</code></pre>

<p>Once all done, the todo-list project in light-example-4j/eventuate will contain POJOs
, two restful services and two hybrid services.</p>

<h2 id="create-a-multiple-modules-maven-project">Create a multiple modules maven project</h2>

<p>Let&rsquo;s create a todo-list folder and copy the pom.xml from the existing project.</p>

<pre><code class="language-$xslt">cd ~/networknt/light-example-4j/eventuate
mkdir todo-list
cd todo-list
cp ../todo-list.bak/pom.xml .

</code></pre>

<p>Now let&rsquo;s copy common, command and query modules to the todo-list folder from existing
one.</p>

<ul>
<li>common contains events and model</li>
<li>command contains command definitions and command side service</li>
<li>query contains query side service</li>
</ul>

<pre><code class="language-$xslt">cd ~/networknt/light-example-4j/eventuate/todo-list
cp -r ../todo-list.bak/common .
cp -r ../todo-list.bak/command .
cp -r ../todo-list.bak/query .

</code></pre>

<p>Now let&rsquo;s open pom.xml to remove other modules and only leave common, command and query.</p>

<p>Let&rsquo;s run the maven build to make sure these three modules can be built.</p>

<pre><code class="language-$xslt">cd ~/networknt/light-example-4j/eventuate/todo-list
mvn clean install
</code></pre>

<h2 id="command-side-restful-service">Command side restful service</h2>

<p>In this step we are going to generate a command side restful microserivce. The model-config
for this service can be found at model-config repo.</p>

<p>Let&rsquo;s first checkout model-config repo from github.</p>

<pre><code class="language-$xslt">git clone git@github.com:networknt/model-config.git

</code></pre>

<p>The swagger specification for todo-list command side service can be found at
~/networknt/model-config/rest/todo-command. In the same folder, there is config.json
which is used to control how light-codegen going to generate the code.</p>

<p>In order to generate the rest-command service, let&rsquo;s first clone the light-codegen
project and build it.</p>

<pre><code class="language-$xslt">cd ~/networknt
git clone git@github.com:networknt/light-codegen.git
cd light-codegen
mvn clean install
</code></pre>

<p>Generate rest-command service with the following command line. Assume we are still in
light-codegen folder.</p>

<pre><code class="language-$xslt">java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/eventuate/todo-list/rest-command -m ../model-config/rest/todo_command/1.0.0/swagger.json -c ../model-config/rest/todo_command/1.0.0/config.json
</code></pre>

<p>Now add this rest-command into pom.xml and build it with maven.</p>

<pre><code class="language-$xslt">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
    &lt;/modules&gt;

</code></pre>

<pre><code class="language-$xslt">mvn clean install
</code></pre>

<p>The four modules should be built successfully.</p>

<p>Now let&rsquo;s update rest-command module to wire the logic.</p>

<p>First we need to update dependencies for this project by adding the following.</p>

<pre><code class="language-$xslt">        &lt;version.light-eventuate-4j&gt;1.3.4&lt;/version.light-eventuate-4j&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>And change the three handlers to the following.</p>

<pre><code class="language-$xslt">package com.networknt.todolist.restcommand.handler;

import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosIdDeleteHandler implements HttpHandler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);

    public void handleRequest(HttpServerExchange exchange) throws Exception {

        // delete a new object
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        TodoInfo todo = (TodoInfo)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        CompletableFuture&lt;TodoInfo&gt; result = service.remove(id).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<pre><code class="language-$xslt">package com.networknt.todolist.restcommand.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosPostHandler implements HttpHandler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);


    public void handleRequest(HttpServerExchange exchange) throws Exception {
        System.out.println(&quot;command side:&quot;);
        ObjectMapper mapper = new ObjectMapper();

        // add a new object
        Map s = (Map)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        String json = mapper.writeValueAsString(s);
        TodoInfo todo = mapper.readValue(json, TodoInfo.class);

        //TodoInfo todo2 = JSonMapper.fromJson(exchange.getAttachment(BodyHandler.REQUEST_BODY),  TodoInfo.class);
        CompletableFuture&lt;TodoInfo&gt; result = service.add(todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });

        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<pre><code class="language-$xslt">package com.networknt.todolist.restcommand.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.common.impl.sync.AggregateCrud;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosPutHandler implements HttpHandler {
    private AggregateCrud aggregateCrud = (AggregateCrud) SingletonServiceFactory.getBean(AggregateCrud.class);
    private EventuateAggregateStore eventStore  = (EventuateAggregateStore)SingletonServiceFactory.getBean(EventuateAggregateStore.class);
    // private TodoCommandService service = (TodoCommandService)SingletonServiceFactory.getBean(TodoCommandService.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);

    public void handleRequest(HttpServerExchange exchange) throws Exception {
        ObjectMapper mapper = new ObjectMapper();      // update a new object
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        Map s = (Map)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        String json = mapper.writeValueAsString(s);
        TodoInfo todo = mapper.readValue(json, TodoInfo.class);

        CompletableFuture&lt;TodoInfo&gt; result = service.update(id, todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<p>Since we are going to create some eventuate class instances from interfaces. Let&rsquo;s create a
service.yml under resources/config folder.</p>

<pre><code class="language-$xslt">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://localhost:3306/eventuate?useSSL=false
      username: mysqluser
      password: mysqlpw
- com.networknt.eventuate.common.impl.sync.AggregateCrud:
  - com.networknt.eventuate.client.EventuateLocalDBAggregateCrud
- com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.client.EventuateLocalAggregatesEvents
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
</code></pre>

<p>Now let&rsquo;s verify that all modules can be built.</p>

<pre><code class="language-$xslt">mvn clean install
</code></pre>

<h2 id="query-side-restful-service">Query side restful service</h2>

<p>The swagger specification for todo-list query side service can be found at
~/networknt/model-config/rest/todo-query. In the same folder, there is config.json
which is used to control how light-codegen going to generate the code.</p>

<p>Generate rest-query service with the following command line. Assume we are still in
light-codegen folder.</p>

<pre><code class="language-$xslt">java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/eventuate/todo-list/rest-query -m ../model-config/rest/todo_query/1.0.0/swagger.json -c ../model-config/rest/todo_query/1.0.0/config.json
</code></pre>

<p>Now add this rest-query into parent pom.xml and build it with maven.</p>

<pre><code class="language-$xslt">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
        &lt;module&gt;rest-query&lt;/module&gt;
    &lt;/modules&gt;

</code></pre>

<pre><code class="language-$xslt">mvn clean install
</code></pre>

<p>The five modules should be built successfully.</p>

<p>Now let&rsquo;s update rest-query module to wire the logic.</p>

<p>First we need to update dependencies for this project by adding the following.</p>

<pre><code class="language-$xslt">        &lt;version.light-eventuate-4j&gt;1.3.4&lt;/version.light-eventuate-4j&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-query&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>Now update the two handler as following.</p>

<pre><code class="language-$xslt">package com.networknt.todolist.restquery.handler;

import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class TodosGetHandler implements HttpHandler {


    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    public void handleRequest(HttpServerExchange exchange) throws Exception {

        List&lt;Map&lt;String, TodoInfo&gt;&gt; resultAll = service.getAll();
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(resultAll));
    }
}

</code></pre>

<pre><code class="language-$xslt">package com.networknt.todolist.restquery.handler;

import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosIdGetHandler implements HttpHandler {
    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    public void handleRequest(HttpServerExchange exchange) throws Exception {
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        CompletableFuture&lt;Map&lt;String, TodoInfo&gt;&gt; result = service.findById(id);
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<p>As rest-query is going to access Mysql database for material view. A class will
be added and put into service.yml below.</p>

<pre><code class="language-$xslt">package com.networknt.todolist.restquery;

import com.networknt.eventuate.common.EventContext;
import com.networknt.eventuate.common.SubscriberOptions;
import com.networknt.eventuate.common.impl.EventIdTypeAndData;
import com.networknt.eventuate.common.impl.SerializedEvent;
import com.networknt.eventuate.common.impl.sync.AggregateCrud;
import com.networknt.eventuate.common.impl.sync.AggregateEvents;
import com.networknt.eventuate.jdbc.AbstractEventuateJdbcAggregateStore;

import javax.sql.DataSource;
import java.util.*;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.atomic.AtomicLong;
import java.util.function.Function;

public class EventuateLocalTestAggregateStore extends AbstractEventuateJdbcAggregateStore
        implements AggregateCrud, AggregateEvents {

  private AtomicLong eventOffset = new AtomicLong();
  private final Map&lt;String, List&lt;Subscription&gt;&gt; aggregateTypeToSubscription = new HashMap&lt;&gt;();

  public EventuateLocalTestAggregateStore(DataSource dataSource) {
    super(dataSource);
  }


  protected void publish(String aggregateType, String aggregateId, List&lt;EventIdTypeAndData&gt; eventsWithIds) {
    System.out.println(&quot;Handler:&quot; +  aggregateTypeToSubscription.size());
    synchronized (aggregateTypeToSubscription) {
      List&lt;Subscription&gt; subscriptions = aggregateTypeToSubscription.get(aggregateType);
      if (subscriptions != null)
        for (Subscription subscription : subscriptions) {
          for (EventIdTypeAndData event : eventsWithIds) {
            if (subscription.isInterestedIn(aggregateType, event.getEventType()))
              subscription.handler.apply(new SerializedEvent(event.getId(), aggregateId, aggregateType, event.getEventData(), event.getEventType(),
                      aggregateId.hashCode() % 8,
                      eventOffset.getAndIncrement(),
                      new EventContext(event.getId().asString()), event.getMetadata()));
          }
        }
    }

  }


  class Subscription {

    private final String subscriberId;
    private final Map&lt;String, Set&lt;String&gt;&gt; aggregatesAndEvents;
    private final Function&lt;SerializedEvent, CompletableFuture&lt;?&gt;&gt; handler;

    public Subscription(String subscriberId, Map&lt;String, Set&lt;String&gt;&gt; aggregatesAndEvents, Function&lt;SerializedEvent, CompletableFuture&lt;?&gt;&gt; handler) {

      this.subscriberId = subscriberId;
      this.aggregatesAndEvents = aggregatesAndEvents;
      this.handler = handler;
    }

    public boolean isInterestedIn(String aggregateType, String eventType) {
      return aggregatesAndEvents.get(aggregateType) != null &amp;&amp; aggregatesAndEvents.get(aggregateType).contains(eventType);
    }
  }

  @Override
  public void subscribe(String subscriberId, Map&lt;String, Set&lt;String&gt;&gt; aggregatesAndEvents, SubscriberOptions options, Function&lt;SerializedEvent, CompletableFuture&lt;?&gt;&gt; handler) {
    // TODO handle options
    Subscription subscription = new Subscription(subscriberId, aggregatesAndEvents, handler);
    synchronized (aggregateTypeToSubscription) {
      for (String aggregateType : aggregatesAndEvents.keySet()) {
        List&lt;Subscription&gt; existing = aggregateTypeToSubscription.get(aggregateType);
        if (existing == null) {
          existing = new LinkedList&lt;&gt;();
          aggregateTypeToSubscription.put(aggregateType, existing);
          System.out.println(&quot;add Handler:&quot; +  existing.size());

        }
        existing.add(subscription);
      }
    }
  }


}

</code></pre>

<p>Since we are going to create some eventuate class instances from interfaces. Let&rsquo;s create a
service.yml under src/main/resources/config folder.</p>

<pre><code class="language-$xslt">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://localhost:3306/todo_db?useSSL=false
      username: mysqluser
      password: mysqlpw
- com.networknt.eventuate.common.impl.sync.AggregateCrud:
  - com.networknt.todolist.restquery.EventuateLocalTestAggregateStore
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.client.KafkaAggregateSubscriptions
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
- com.networknt.eventuate.todolist.TodoQueryRepository:
  - com.networknt.eventuate.todolist.TodoQueryRepositoryImpl
- com.networknt.eventuate.todolist.TodoQueryService:
  - com.networknt.eventuate.todolist.TodoQueryServiceImpl
- com.networknt.eventuate.todolist.TodoQueryWorkflow:
  - com.networknt.eventuate.todolist.TodoQueryWorkflow
- com.networknt.eventuate.event.EventHandlerProcessor:
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningVoid
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningVoid
- com.networknt.eventuate.client.SubscriptionsRegistry:
  - com.networknt.eventuate.client.SubscriptionsRegistryImpl

</code></pre>

<p>As there are test cases and a test server will be started, we need to create a
service.yml in /src/test/resources/config folder to utilize H2 database for
our test cases.</p>

<pre><code class="language-$xslt">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: org.h2.jdbcx.JdbcDataSource
      jdbcUrl: jdbc:h2:~/test
      username: sa
      password: sa
- com.networknt.eventuate.common.impl.sync.AggregateCrud,com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.test.jdbc.EventuateEmbeddedTestAggregateStore
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
- com.networknt.eventuate.todolist.TodoQueryRepository:
  - com.networknt.eventuate.todolist.TodoQueryRepositoryImpl
- com.networknt.eventuate.todolist.TodoQueryService:
  - com.networknt.eventuate.todolist.TodoQueryServiceImpl
- com.networknt.eventuate.todolist.TodoQueryWorkflow:
  - com.networknt.eventuate.todolist.TodoQueryWorkflow
- com.networknt.eventuate.event.EventHandlerProcessor:
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningVoid
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningVoid
- com.networknt.eventuate.client.SubscriptionsRegistry:
  - com.networknt.eventuate.client.SubscriptionsRegistryImpl

</code></pre>

<p>The rest-query will subscribe events from light-eventuate-4j so it need to
config event handler registration in the StartupHookProvider.</p>

<pre><code class="language-$xslt"># This is the place to plugin your startup hooks to initialize Spring application context,
# set up db connection pools and allocate resources.

# config event handle registration
com.networknt.eventuate.client.EventuateClientStartupHookProvider
</code></pre>

<p>Now let&rsquo;s verify that all modules can be built.</p>

<pre><code class="language-$xslt">mvn clean install
</code></pre>

<h2 id="test-restful-services">Test restful services</h2>

<p>Once all modules can be built successfully, we can start the servers and test the todo-list
application.</p>

<p>First we need to make sure Mysql, Zookeeper, Kafka and CDC server are up and running.</p>

<p>You can follow this <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/">tutorial</a>
to start all of them with docker-compose.</p>

<p>Before we start the rest-command and rest-query, let&rsquo;s create the database and table
for the rest-query material view in the same Mysql database for the event store. We
are going to create another database called todo_db</p>

<p>Here is the db script and you can use mysql command line or just using any GUI tools
to run it against Mysql server.</p>

<pre><code class="language-$xslt">create database todo_db;

GRANT ALL PRIVILEGES ON todo_db.* TO 'mysqluser' IDENTIFIED BY 'mysqlpw';

use todo_db;

DROP table IF EXISTS  TODO;


CREATE  TABLE TODO (
  ID varchar(255),
  TITLE varchar(255),
  COMPLETED BOOLEAN,
  ORDER_ID INTEGER,
  ACTIVE_FLG varchar(1) DEFAULT 'Y',
  PRIMARY KEY(ID)
);


</code></pre>

<p>Remember that Mysql root user and password as follows.</p>

<pre><code class="language-$xslt">dbUser: root
dbPass: rootpassword

</code></pre>

<p>Now let&rsquo;s start rest-command service</p>

<pre><code class="language-$xslt">cd ~/networknt/light-example-4j/eventuate/todo-list/rest-command
java -jar target/rest-command-1.0.0.jar
</code></pre>

<p>Now let&rsquo;s start rest-query service</p>

<pre><code class="language-$xslt">cd ~/networknt/light-example-4j/eventuate/todo-list/rest-query
java -jar target/rest-query-1.0.0.jar
</code></pre>

<p>Let&rsquo;s create a todo item with curl</p>

<pre><code class="language-$xslt">curl -X POST \
  http://localhost:8083/v1/todos \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -d '{&quot;title&quot;:&quot;this is the test todo from postman&quot;,&quot;completed&quot;:false,&quot;order&quot;:0}'
</code></pre>

<p>And the response will be</p>

<pre><code class="language-$xslt">{
    &quot;cancelled&quot;: false,
    &quot;done&quot;: true,
    &quot;completedExceptionally&quot;: false,
    &quot;numberOfDependents&quot;: 0
}
</code></pre>

<p>Now let&rsquo;s access the rest-query service</p>

<pre><code class="language-$xslt">curl -X GET http://localhost:8082/v1/todos
</code></pre>

<p>And the response will be something like this.</p>

<pre><code class="language-$xslt">[
    {
        &quot;0000015d968eacee-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    },
    {
        &quot;0000015d968f5443-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    },
    {
        &quot;0000015d969d6ce2-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    }
]
</code></pre>

<h2 id="command-side-hybrid-service">Command side hybrid service</h2>

<h2 id="query-side-hybrid-service">Query side hybrid service</h2>

<h2 id="test-hybrid-services">Test hybrid services</h2>

<h2 id="test-with-todo-list-example-application">Test with todo-list example application</h2>

<p>Prepare query side DB script: (DB script saved at: /light-eventuate-example/mysql; root user for mysql: root/rootpassword)</p>

<pre><code>create database todo_db;

CREATE  TABLE TODO (
  ID varchar(255),
  TITLE varchar(255),
  COMPLETED BOOLEAN,
  ORDER_ID INTEGER,
  ACTIVE_FLG varchar(1) DEFAULT 'Y',
  PRIMARY KEY(ID)
);

GRANT ALL PRIVILEGES ON todo_db.* TO 'mysqluser' IDENTIFIED BY 'mysqlpw';
</code></pre>

<p>Go query-service module, run command line:
   &ndash; mvn package exec:exec</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/" title="Workspace setup for developing light-eventuate-4j services">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Workspace setup for developing light-eventuate-4j services
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/light-eventuate-4j';
      var repo_id  = 'networknt\/light-eventuate-4j';
    
    </script>

    <script src="https://networknt.github.io/light-eventuate-4j/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

