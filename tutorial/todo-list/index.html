<!DOCTYPE html>
  
  
  
  
   <html class="no-js"> 

  <head lang="en-us">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=10" />
    <title>Todo list tutorial - Light Eventuate 4J - An event sourcing and CQRS framework with Kafka</title>
    <meta name="generator" content="Hugo 0.21-DEV" />

    
    <meta name="description" content="Light Eventuate Docs">
    
    <link rel="canonical" href="https://networknt.github.io/light-eventuate-4j/tutorial/todo-list/">
    
    <meta name="author" content="Steve Hu, Gavin Chen">
    

    <meta property="og:url" content="https://networknt.github.io/light-eventuate-4j/tutorial/todo-list/">
    <meta property="og:title" content="Light Eventuate 4J - An event sourcing and CQRS framework with Kafka">
    <meta property="og:image" content="https://networknt.github.io/light-eventuate-4j/images/logo.png">
    <meta name="apple-mobile-web-app-title" content="Light Eventuate 4J - An event sourcing and CQRS framework with Kafka">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="shortcut icon" type="image/x-icon" href="https://networknt.github.io/light-eventuate-4j/images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="https://networknt.github.io/light-eventuate-4j/images/favicon.ico">

    <style>
      @font-face {
        font-family: 'Icon';
        src: url('https://networknt.github.io/light-eventuate-4j/fonts/icon.eot');
        src: url('https://networknt.github.io/light-eventuate-4j/fonts/icon.eot')
               format('embedded-opentype'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.woff')
               format('woff'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.ttf')
               format('truetype'),
             url('https://networknt.github.io/light-eventuate-4j/fonts/icon.svg')
               format('svg');
        font-weight: normal;
        font-style: normal;
      }
    </style>

    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/application.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/temporary.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/palettes.css">
    <link rel="stylesheet" href="https://networknt.github.io/light-eventuate-4j/stylesheets/highlight/highlight.css">

    
    
    
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu&#43;Mono">
    <style>
      body, input {
        font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
      }
      pre, code {
        font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
      }
    </style>

    
    <script src="https://networknt.github.io/light-eventuate-4j/javascripts/modernizr.js"></script>

    

  </head>
  <body class="palette-primary-red palette-accent-teal">



	
	


<div class="backdrop">
	<div class="backdrop-paper"></div>
</div>

<input class="toggle" type="checkbox" id="toggle-drawer">
<input class="toggle" type="checkbox" id="toggle-search">
<label class="toggle-button overlay" for="toggle-drawer"></label>

<header class="header">
	<nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        Todo list tutorial
      </div>
    </div>

    

    
    <div class="button button-github" role="button" aria-label="GitHub">
      <a href="https://github.com/stevehu" title="@stevehu on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
    </div>
    
    
        
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
</header>

<main class="main">
	<div class="drawer">
		<nav aria-label="Navigation">
  <a href="https://github.com/networknt/light-eventuate-4j" class="project">
    <div class="banner">
      
        <div class="logo">
          <img src="https://networknt.github.io/light-eventuate-4jimages/logo.png">
        </div>
      
      <div class="name">
        <strong>Light Eventuate 4J - An event sourcing and CQRS framework with Kafka <span class="version">1.3.5</span></strong>
        
          <br>
          networknt/light-eventuate-4j
        
      </div>
    </div>
  </a>

  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            <a href="https://github.com/networknt/light-eventuate-4j/archive/master.zip" target="_blank" title="Download" data-action="download">
              <i class="icon icon-download"></i> Download
            </a>
          </li>
          <li class="repo-stars">
            <a href="https://github.com/networknt/light-eventuate-4j/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      

      <div class="toc">
        
        <ul>
          




<li>
  
    



<a  title="Getting started" href="https://networknt.github.io/light-eventuate-4j/getting-started/">
	
	Getting started
</a>



  
</li>



<li>
  
    



<a  title="Architecture" href="https://networknt.github.io/light-eventuate-4j/architecture/">
	
	Architecture
</a>



  
</li>



<li>
  
    



<a  title="Design" href="https://networknt.github.io/light-eventuate-4j/design/">
	
	Design
</a>



  
</li>



<li>
  
    



<a  title="Component" href="https://networknt.github.io/light-eventuate-4j/component/">
	
	Component
</a>



  
</li>



<li>
  
    



<a  title="Tutorial" href="https://networknt.github.io/light-eventuate-4j/tutorial/">
	
	Tutorial
</a>



  
</li>



<li>
  
    



<a  title="Example" href="https://networknt.github.io/light-eventuate-4j/example/">
	
	Example
</a>



  
</li>



<li>
  
    



<a  title="Issues &amp; Help" href="https://github.com/networknt/light-eventuate/issues">
	
	Issues &amp; Help
</a>



  
</li>



<li>
  
    



<a  title="Roadmap" href="https://networknt.github.io/light-eventuate-4j/roadmap/">
	
	Roadmap
</a>



  
</li>



<li>
  
    



<a  title="License" href="https://www.apache.org/licenses/LICENSE-2.0">
	
	License
</a>



  
</li>



<li>
  
    



<a  title="Introduction" href="https://networknt.github.io/light-eventuate-4j/index.html">
	
	Introduction
</a>



  
</li>


        </ul>
        

        
        <hr>
        <span class="section">The author</span>
        
        <ul>
          

          
          <li>
            <a href="https://github.com/stevehu" target="_blank" title="@stevehu on GitHub">
              @stevehu on GitHub
            </a>
          </li>
          

          
          <li>
            <a href="mailto:stevehu@gmail.com" title="Email of stevehu@gmail.com">
              Contact via email
            </a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</nav>

	</div>

	<article class="article">
		<div class="wrapper">
			<h1>Todo list tutorial </h1>

			

<p>This is the most simple Hello World type of application with event sourcing
and CQRS on top of light-eventuate-4j. It has command side service that add
new todo item, update existing todo item and remove todo item(s). It also
has query side service to retrieve all the todo items for display in the web
single page application.</p>

<p>The following steps will assume you know the basic about light-eventuate-4j
as well as light-rest-4j and light-hybrid-4j as we are going to build services
in RESTful style and Hybrid style.</p>

<p>Before starting any service, we need to make sure that light-eventuate-4j is
up and running. Please follow this <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/">tutorial</a>
to set up.</p>

<p>We are going to implement the application in both light-rest-4j and light-hybrid-4
and the two implementations will be sitting in the same folders in light-example-4j.</p>

<p>As the todo-list folder already in the public repo of light-example-4j/eventuate, we
are going to rename the existing project and you can compare these folders if you want.</p>

<h2 id="prepare-environment">Prepare environment</h2>

<p>Assuming that light-eventuate-4j platform is up and running, let&rsquo;s checkout the
light-example-4j project and rename todo-list folder in eventuate so that we can
recreate it in this tutorial.</p>

<p>As other tutorials, we are going to use networknt under user&rsquo;s home directory as
workspace.</p>

<pre><code>cd ~/networknt
git clone git@github.com:networknt/light-example-4j.git
cd light-example-4j/eventuate
mv todo-list todo-list.bak
</code></pre>

<p>Once all done, the todo-list project in light-example-4j/eventuate will contain POJOs
, two restful services and two hybrid services.</p>

<h2 id="create-a-multiple-modules-maven-project">Create a multiple modules maven project</h2>

<p>Let&rsquo;s create a todo-list folder and copy the pom.xml from the existing project.</p>

<pre><code>cd ~/networknt/light-example-4j/eventuate
mkdir todo-list
cd todo-list
cp ../todo-list.bak/pom.xml .

</code></pre>

<p>Now let&rsquo;s copy common, command and query modules to the todo-list folder from existing
one.</p>

<ul>
<li>common contains events and model</li>
<li>command contains command definitions and command side service</li>
<li>query contains query side service</li>
</ul>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list
cp -r ../todo-list.bak/common .
cp -r ../todo-list.bak/command .
cp -r ../todo-list.bak/query .

</code></pre>

<p>Now let&rsquo;s open pom.xml to remove other modules and only leave common, command and query:</p>

<pre><code>    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
    &lt;/modules&gt;

</code></pre>

<p>Let&rsquo;s run the maven build to make sure these three modules can be built.</p>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list
mvn clean install
</code></pre>

<h2 id="command-side-restful-service">Command side restful service</h2>

<p>In this step we are going to generate a command side restful microserivce. The model-config
for this service can be found at model-config repo.</p>

<p>Let&rsquo;s first checkout model-config repo from github.</p>

<pre><code>git clone git@github.com:networknt/model-config.git

</code></pre>

<p>The swagger specification for todo-list command side service can be found at
~/networknt/model-config/rest/todo-command. In the same folder, there is config.json
which is used to control how light-codegen going to generate the code.</p>

<p>In order to generate the rest-command service, let&rsquo;s first clone the light-codegen
project and build it.</p>

<pre><code>cd ~/networknt
git clone git@github.com:networknt/light-codegen.git
cd light-codegen
mvn clean install
</code></pre>

<p>Generate rest-command service with the following command line. Assume we are still in
light-codegen folder.</p>

<pre><code>java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/eventuate/todo-list/rest-command -m ../model-config/rest/todo_command/1.0.0/swagger.json -c ../model-config/rest/todo_command/1.0.0/config.json
</code></pre>

<p>Now add this rest-command into pom.xml and build it with maven.</p>

<pre><code class="language-xml">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
    &lt;/modules&gt;

</code></pre>

<pre><code>mvn clean install
</code></pre>

<p>The four modules should be built successfully.</p>

<p>Now let&rsquo;s update rest-command module to wire the logic.</p>

<p>First we need to update dependencies for this project by adding the following.</p>

<pre><code class="language-xml">        &lt;version.light-eventuate-4j&gt;1.3.5&lt;/version.light-eventuate-4j&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>And change the three handlers to the following.</p>

<pre><code class="language-java">package com.networknt.todolist.restcommand.handler;

import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosIdDeleteHandler implements HttpHandler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);

    public void handleRequest(HttpServerExchange exchange) throws Exception {

        // delete a new object
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        TodoInfo todo = (TodoInfo)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        CompletableFuture&lt;TodoInfo&gt; result = service.remove(id).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.restcommand.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosPostHandler implements HttpHandler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);


    public void handleRequest(HttpServerExchange exchange) throws Exception {
        System.out.println(&quot;command side:&quot;);
        ObjectMapper mapper = new ObjectMapper();

        // add a new object
        Map s = (Map)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        String json = mapper.writeValueAsString(s);
        TodoInfo todo = mapper.readValue(json, TodoInfo.class);

        //TodoInfo todo2 = JSonMapper.fromJson(exchange.getAttachment(BodyHandler.REQUEST_BODY),  TodoInfo.class);
        CompletableFuture&lt;TodoInfo&gt; result = service.add(todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });

        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.restcommand.handler;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.networknt.body.BodyHandler;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.common.impl.sync.AggregateCrud;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosPutHandler implements HttpHandler {
    private AggregateCrud aggregateCrud = (AggregateCrud) SingletonServiceFactory.getBean(AggregateCrud.class);
    private EventuateAggregateStore eventStore  = (EventuateAggregateStore)SingletonServiceFactory.getBean(EventuateAggregateStore.class);
    // private TodoCommandService service = (TodoCommandService)SingletonServiceFactory.getBean(TodoCommandService.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);

    public void handleRequest(HttpServerExchange exchange) throws Exception {
        ObjectMapper mapper = new ObjectMapper();      // update a new object
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        Map s = (Map)exchange.getAttachment(BodyHandler.REQUEST_BODY);
        String json = mapper.writeValueAsString(s);
        TodoInfo todo = mapper.readValue(json, TodoInfo.class);

        CompletableFuture&lt;TodoInfo&gt; result = service.update(id, todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<p>Since we are going to create some eventuate class instances from interfaces. Let&rsquo;s create a
service.yml under resources/config folder.</p>

<pre><code class="language-yaml">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://localhost:3306/eventuate?useSSL=false
      username: mysqluser
      password: mysqlpw
- com.networknt.eventuate.common.impl.sync.AggregateCrud:
  - com.networknt.eventuate.client.EventuateLocalDBAggregateCrud
- com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.client.EventuateLocalAggregatesEvents
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
</code></pre>

<p>Now let&rsquo;s verify that all modules can be built.</p>

<pre><code>mvn clean install
</code></pre>

<h2 id="query-side-restful-service">Query side restful service</h2>

<p>The swagger specification for todo-list query side service can be found at
~/networknt/model-config/rest/todo-query. In the same folder, there is config.json
which is used to control how light-codegen going to generate the code.</p>

<p>Generate rest-query service with the following command line. Assume we are still in
light-codegen folder.</p>

<pre><code>java -jar codegen-cli/target/codegen-cli.jar -f light-rest-4j -o ../light-example-4j/eventuate/todo-list/rest-query -m ../model-config/rest/todo_query/1.0.0/swagger.json -c ../model-config/rest/todo_query/1.0.0/config.json
</code></pre>

<p>Now add this rest-query into parent pom.xml and build it with maven.</p>

<pre><code class="language-xml">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
        &lt;module&gt;rest-query&lt;/module&gt;
    &lt;/modules&gt;

</code></pre>

<pre><code>mvn clean install
</code></pre>

<p>The five modules should be built successfully.</p>

<p>Now let&rsquo;s update rest-query module to wire the logic.</p>

<p>First we need to update dependencies for this project by adding the following.</p>

<pre><code class="language-xml">        &lt;version.light-eventuate-4j&gt;1.3.5&lt;/version.light-eventuate-4j&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-query&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>Now update the two handler as following.</p>

<pre><code class="language-java">package com.networknt.todolist.restquery.handler;

import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class TodosGetHandler implements HttpHandler {


    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    public void handleRequest(HttpServerExchange exchange) throws Exception {

        List&lt;Map&lt;String, TodoInfo&gt;&gt; resultAll = service.getAll();
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(resultAll));
    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.restquery.handler;

import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import io.undertow.server.HttpHandler;
import io.undertow.server.HttpServerExchange;
import io.undertow.util.HttpString;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

public class TodosIdGetHandler implements HttpHandler {
    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    public void handleRequest(HttpServerExchange exchange) throws Exception {
        String id = exchange.getQueryParameters().get(&quot;id&quot;).getFirst();
        CompletableFuture&lt;Map&lt;String, TodoInfo&gt;&gt; result = service.findById(id);
        exchange.getResponseHeaders().add(new HttpString(&quot;Content-Type&quot;), &quot;application/json&quot;);
        exchange.getResponseSender().send(Config.getInstance().getMapper().writeValueAsString(result));
    }
}

</code></pre>

<p>Since we are going to create some eventuate class instances from interfaces. Let&rsquo;s create a
service.yml under src/main/resources/config folder.</p>

<pre><code class="language-yaml">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://localhost:3306/todo_db?useSSL=false
      username: mysqluser
      password: mysqlpw
- com.networknt.eventuate.common.impl.sync.AggregateCrud:
  - com.networknt.eventuate.jdbc.EventuateLocalAggregateStore
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.client.KafkaAggregateSubscriptions
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
- com.networknt.eventuate.todolist.TodoQueryRepository:
  - com.networknt.eventuate.todolist.TodoQueryRepositoryImpl
- com.networknt.eventuate.todolist.TodoQueryService:
  - com.networknt.eventuate.todolist.TodoQueryServiceImpl
- com.networknt.eventuate.todolist.TodoQueryWorkflow:
  - com.networknt.eventuate.todolist.TodoQueryWorkflow
- com.networknt.eventuate.event.EventHandlerProcessor:
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningVoid
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningVoid
- com.networknt.eventuate.client.SubscriptionsRegistry:
  - com.networknt.eventuate.client.SubscriptionsRegistryImpl

</code></pre>

<p>As there are test cases and a test server will be started, we need to create a
service.yml in /src/test/resources/config folder to utilize H2 database for
our test cases.</p>

<pre><code class="language-yaml">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: org.h2.jdbcx.JdbcDataSource
      jdbcUrl: jdbc:h2:~/test
      username: sa
      password: sa
- com.networknt.eventuate.common.impl.sync.AggregateCrud,com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.test.jdbc.EventuateEmbeddedTestAggregateStore
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
- com.networknt.eventuate.todolist.TodoQueryRepository:
  - com.networknt.eventuate.todolist.TodoQueryRepositoryImpl
- com.networknt.eventuate.todolist.TodoQueryService:
  - com.networknt.eventuate.todolist.TodoQueryServiceImpl
- com.networknt.eventuate.todolist.TodoQueryWorkflow:
  - com.networknt.eventuate.todolist.TodoQueryWorkflow
- com.networknt.eventuate.event.EventHandlerProcessor:
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningVoid
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningVoid
- com.networknt.eventuate.client.SubscriptionsRegistry:
  - com.networknt.eventuate.client.SubscriptionsRegistryImpl

</code></pre>

<p>The rest-query will subscribe events from light-eventuate-4j so it need to
config event handler registration in the StartupHookProvider.</p>

<pre><code># This is the place to plugin your startup hooks to initialize Spring application context,
# set up db connection pools and allocate resources.

# config event handle registration
com.networknt.eventuate.client.EventuateClientStartupHookProvider
</code></pre>

<p>Now let&rsquo;s verify that all modules can be built.</p>

<pre><code>mvn clean install
</code></pre>

<h2 id="test-restful-services">Test restful services</h2>

<p>Once all modules can be built successfully, we can start the servers and test the todo-list
application.</p>

<p>First we need to make sure Mysql, Zookeeper, Kafka and CDC server are up and running.</p>

<p>You can follow this <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/">tutorial</a>
to start all of them with docker-compose.</p>

<p>Before we start the rest-command and rest-query, let&rsquo;s create the database and table
for the rest-query material view in the same Mysql database for the event store. We
are going to create another database called todo_db</p>

<p>Here is the db script and you can use mysql command line or just using any GUI tools
to run it against Mysql server.</p>

<pre><code class="language-mysql">create database todo_db;

GRANT ALL PRIVILEGES ON todo_db.* TO 'mysqluser' IDENTIFIED BY 'mysqlpw';

use todo_db;

DROP table IF EXISTS  TODO;


CREATE  TABLE TODO (
  ID varchar(255),
  TITLE varchar(255),
  COMPLETED BOOLEAN,
  ORDER_ID INTEGER,
  ACTIVE_FLG varchar(1) DEFAULT 'Y',
  PRIMARY KEY(ID)
);


</code></pre>

<p>Remember that Mysql root user and password as follows.</p>

<pre><code>dbUser: root
dbPass: rootpassword

</code></pre>

<p>Now let&rsquo;s start rest-command service</p>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list/rest-command
java -jar target/rest-command-1.0.0.jar
</code></pre>

<p>Now let&rsquo;s start rest-query service</p>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list/rest-query
java -jar target/rest-query-1.0.0.jar
</code></pre>

<p>Let&rsquo;s create a todo item with curl</p>

<pre><code>curl -X POST \
  http://localhost:8083/v1/todos \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -d '{&quot;title&quot;:&quot;this is the test todo from postman&quot;,&quot;completed&quot;:false,&quot;order&quot;:0}'
</code></pre>

<p>And the response will be</p>

<pre><code class="language-json">{
    &quot;cancelled&quot;: false,
    &quot;done&quot;: true,
    &quot;completedExceptionally&quot;: false,
    &quot;numberOfDependents&quot;: 0
}
</code></pre>

<p>Now let&rsquo;s access the rest-query service</p>

<pre><code>curl -X GET http://localhost:8082/v1/todos
</code></pre>

<p>And the response will be something like this.</p>

<pre><code class="language-json">[
    {
        &quot;0000015d968eacee-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    },
    {
        &quot;0000015d968f5443-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    },
    {
        &quot;0000015d969d6ce2-0e23a9398a990001&quot;: {
            &quot;title&quot;: &quot;this is the test todo from postman&quot;,
            &quot;completed&quot;: false,
            &quot;order&quot;: 0
        }
    }
]
</code></pre>

<h2 id="command-side-hybrid-service">Command side hybrid service</h2>

<p>So far, we have tried to implement both Command and Query services with Restful
APIs. From this step, we are going to implement these service with light-hybrid-4j
framework. Although we can put cdc-service, hybrid-command, hybrid-query into the
same hybrid server instance, we are going to use two hybrid server instances to
show case Command Query Responsibility Segregation(CQRS).</p>

<p>If we use hybrid framework, we don&rsquo;t need the RESTful CDC service anymore. We can
put the cdc-service into the hybrid-command server.</p>

<p>To create command side hybrid server, we are going to use light-codegen to generate
the project in todo-list. Before generating the project, we need to create a config.json
to control how generator works and a schema.json to define the service contract.</p>

<p>These two files can be found in model-config/hybrid/todo-command folder.</p>

<p>config.json</p>

<pre><code class="language-json">{
  &quot;rootPackage&quot;: &quot;com.networknt.todolist.command&quot;,
  &quot;handlerPackage&quot;:&quot;com.networknt.todolist.command.handler&quot;,
  &quot;modelPackage&quot;:&quot;com.networknt.todolist.command.model&quot;,
  &quot;artifactId&quot;: &quot;hybrid-command&quot;,
  &quot;groupId&quot;: &quot;com.networknt&quot;,
  &quot;name&quot;: &quot;hybrid-command&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;overwriteHandler&quot;: true,
  &quot;overwriteHandlerTest&quot;: true
}

</code></pre>

<p>schema.json</p>

<pre><code class="language-json">{
  &quot;host&quot;: &quot;lightapi.net&quot;,
  &quot;service&quot;: &quot;todo&quot;,
  &quot;action&quot;: [
   {
    &quot;name&quot;: &quot;delete&quot;,
    &quot;version&quot;: &quot;0.1.0&quot;,
    &quot;handler&quot;: &quot;DeleteTodo&quot;,
    &quot;scope&quot; : &quot;todo.w&quot;,    
    &quot;schema&quot; : {
      &quot;title&quot; : &quot;Service&quot;,
      &quot;type&quot; : &quot;object&quot;,
      &quot;properties&quot; : {
        &quot;id&quot; : {
          &quot;type&quot; : &quot;string&quot;
        }
      },
      &quot;required&quot; : [ &quot;id&quot;]
    },
    &quot;scope&quot; : &quot;todo.w&quot;
  },
  {
      &quot;name&quot;: &quot;create&quot;,
      &quot;version&quot;: &quot;0.1.0&quot;,
      &quot;handler&quot;: &quot;CreateTodo&quot;,
      &quot;scope&quot; : &quot;todo.w&quot;,
      &quot;schema&quot; : {
      &quot;title&quot; : &quot;Service&quot;,
      &quot;type&quot; : &quot;object&quot;,
      &quot;properties&quot; : {
        &quot;title&quot; : {
          &quot;type&quot; : &quot;string&quot;
        },
        &quot;completed&quot; : {
          &quot;type&quot; : &quot;boolean&quot;
        },
        &quot;order&quot; : {
          &quot;description&quot; : &quot;order of todo in the todo list&quot;,
          &quot;type&quot; : &quot;integer&quot;,
          &quot;minimum&quot; : 0
        }
      },
      &quot;required&quot; : [ &quot;title&quot; ]
    },
    &quot;scope&quot; : &quot;todo.w&quot;
  },
{
      &quot;name&quot;: &quot;update&quot;,
      &quot;version&quot;: &quot;0.1.0&quot;,
      &quot;handler&quot;: &quot;UpdateTodo&quot;,
      &quot;scope&quot; : &quot;todo.w&quot;,
      &quot;schema&quot; : {
      &quot;title&quot; : &quot;Service&quot;,
      &quot;type&quot; : &quot;object&quot;,
      &quot;properties&quot; : {
        &quot;id&quot; : {
          &quot;type&quot; : &quot;string&quot;
        },
        &quot;title&quot; : {
          &quot;type&quot; : &quot;string&quot;
        },
        &quot;completed&quot; : {
          &quot;type&quot; : &quot;boolean&quot;
        },
        &quot;order&quot; : {
          &quot;description&quot; : &quot;order of todo in the todo list&quot;,
          &quot;type&quot; : &quot;integer&quot;,
          &quot;minimum&quot; : 0
        }
      },
      &quot;required&quot; : [ &quot;id&quot; ]
    },
    &quot;scope&quot; : &quot;todo.w&quot;
  }
  ]
}
</code></pre>

<p>Now let&rsquo;s run the light-codegen command line to generate the project.</p>

<pre><code>java -jar codegen-cli/target/codegen-cli.jar -f light-hybrid-4j-service -o ../light-example-4j/eventuate/todo-list/hybrid-command -m ../model-config/hybrid/todo-command/schema.json -c ../model-config/hybrid/todo-command/config.json
</code></pre>

<p>Let&rsquo;s add this newly generated project to the parent pom.xml and build all
modules.</p>

<pre><code class="language-xml">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
        &lt;module&gt;rest-query&lt;/module&gt;
        &lt;module&gt;hybrid-command&lt;/module&gt;
    &lt;/modules&gt;
</code></pre>

<pre><code class="language-xml">            &lt;dependency&gt;
                &lt;groupId&gt;com.networknt&lt;/groupId&gt;
                &lt;artifactId&gt;hybrid-command&lt;/artifactId&gt;
                &lt;version&gt;${project.version}&lt;/version&gt;
            &lt;/dependency&gt;

</code></pre>

<p>Rebuild all modules from root folder.</p>

<pre><code>mvn clean install

</code></pre>

<p>Now let&rsquo;s change the dependencies to add light-eventuate-4j modules and todo-list
modules.</p>

<pre><code class="language-xml">        &lt;version.light-eventuate-4j&gt;1.3.5&lt;/version.light-eventuate-4j&gt;

</code></pre>

<pre><code class="language-xml">        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>With all the dependencies are added, let&rsquo;s change the handler to wire in the
right logic.</p>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.fasterxml.jackson.databind.JsonNode;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import com.networknt.utility.NioUtils;
import com.networknt.rpc.Handler;
import com.networknt.rpc.router.ServiceHandler;
import java.nio.ByteBuffer;
import java.util.concurrent.CompletableFuture;

@ServiceHandler(id=&quot;lightapi.net/todo/create/0.1.0&quot;)
public class CreateTodo implements Handler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);

    @Override
    public ByteBuffer handle(Object input)  {

        JsonNode inputPara = Config.getInstance().getMapper().valueToTree(input);

        TodoInfo todo = new TodoInfo();
        todo.setTitle(inputPara.findPath(&quot;title&quot;).asText());
        todo.setCompleted(inputPara.findPath(&quot;completed&quot;).asBoolean());
        todo.setOrder(inputPara.findPath(&quot;order&quot;).asInt());

        CompletableFuture&lt;TodoInfo&gt; result = service.add(todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });

        return NioUtils.toByteBuffer(&quot;{\&quot;message\&quot;:&quot; + result + &quot;}&quot;);
    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.fasterxml.jackson.databind.JsonNode;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import com.networknt.utility.NioUtils;
import com.networknt.rpc.Handler;
import com.networknt.rpc.router.ServiceHandler;
import java.nio.ByteBuffer;
import java.util.concurrent.CompletableFuture;

@ServiceHandler(id=&quot;lightapi.net/todo/delete/0.1.0&quot;)
public class DeleteTodo implements Handler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);


    @Override
    public ByteBuffer handle(Object input)  {

        JsonNode inputPara = Config.getInstance().getMapper().valueToTree(input);
        // delete a todo-event
        String id = inputPara.findPath(&quot;id&quot;).asText();

        CompletableFuture&lt;TodoInfo&gt; result = service.remove(id).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });


        return NioUtils.toByteBuffer(&quot;{\&quot;message\&quot;:&quot; + result + &quot;}&quot;);
    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.fasterxml.jackson.databind.JsonNode;
import com.networknt.config.Config;
import com.networknt.eventuate.common.AggregateRepository;
import com.networknt.eventuate.common.EventuateAggregateStore;
import com.networknt.eventuate.todolist.TodoCommandService;
import com.networknt.eventuate.todolist.TodoCommandServiceImpl;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.eventuate.todolist.domain.TodoAggregate;
import com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate;
import com.networknt.service.SingletonServiceFactory;
import com.networknt.utility.NioUtils;
import com.networknt.rpc.Handler;
import com.networknt.rpc.router.ServiceHandler;
import java.nio.ByteBuffer;
import java.util.concurrent.CompletableFuture;

@ServiceHandler(id=&quot;lightapi.net/todo/update/0.1.0&quot;)
public class UpdateTodo implements Handler {

    private EventuateAggregateStore eventStore  = (EventuateAggregateStore) SingletonServiceFactory.getBean(EventuateAggregateStore.class);

    private AggregateRepository todoRepository = new AggregateRepository(TodoAggregate.class, eventStore);
    private AggregateRepository bulkDeleteAggregateRepository  = new AggregateRepository(TodoBulkDeleteAggregate.class, eventStore);

    private TodoCommandService service = new TodoCommandServiceImpl(todoRepository, bulkDeleteAggregateRepository);
    @Override
    public ByteBuffer handle(Object input)  {

        JsonNode inputPara = Config.getInstance().getMapper().valueToTree(input);

        String id = inputPara.findPath(&quot;id&quot;).asText();;
        TodoInfo todo = new TodoInfo();
        todo.setTitle(inputPara.findPath(&quot;title&quot;).asText());
        todo.setCompleted(inputPara.findPath(&quot;completed&quot;).asBoolean());
        todo.setOrder(inputPara.findPath(&quot;order&quot;).asInt());

        CompletableFuture&lt;TodoInfo&gt; result = service.update(id, todo).thenApply((e) -&gt; {
            TodoInfo m = e.getAggregate().getTodo();
            return m;
        });


        return NioUtils.toByteBuffer(&quot;{\&quot;message\&quot;:&quot; + result + &quot;}&quot;);
    }
}

</code></pre>

<p>As we have to put the service jar into the hybrid server platform in order to run
it, we cannot wait then to test it. So for hybrid service development, end-to-end
test is very important to ensure what you have built is working.</p>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.networknt.client.Client;
import com.networknt.server.Server;
import com.networknt.exception.ClientException;
import com.networknt.exception.ApiException;
import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.*;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.jose4j.json.internal.json_simple.JSONObject;
import org.junit.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class CreateTodoTest {
    @ClassRule
    public static TestServer server = TestServer.getInstance();

    static final Logger logger = LoggerFactory.getLogger(CreateTodo.class);

    @Test
    public void testCreateTodo() throws ClientException, ApiException {
        CloseableHttpClient client = Client.getInstance().getSyncClient();
        HttpPost httpPost = new HttpPost(&quot;http://localhost:8080/api/json&quot;);

        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;host&quot;, &quot;lightapi.net&quot;);
        map.put(&quot;service&quot;, &quot;todo&quot;);
        map.put(&quot;action&quot;, &quot;create&quot;);
        map.put(&quot;version&quot;, &quot;0.1.0&quot;);
        map.put(&quot;title&quot;, &quot;create todo from hybrid service unit test&quot;);
        map.put(&quot;completed&quot;, false);
        map.put(&quot;order&quot;, 1);
        JSONObject json = new JSONObject();
        json.putAll( map );
        System.out.printf( &quot;JSON: %s&quot;, json.toString() );


        //Client.getInstance().addAuthorization(httpPost);
        try {
            httpPost.setEntity(new StringEntity(json.toString()));
            httpPost.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
            CloseableHttpResponse response = client.execute(httpPost);
            Assert.assertEquals(200, response.getStatusLine().getStatusCode());

        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
</code></pre>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.networknt.client.Client;
import com.networknt.server.Server;
import com.networknt.exception.ClientException;
import com.networknt.exception.ApiException;
import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.*;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.jose4j.json.internal.json_simple.JSONObject;
import org.junit.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class DeleteTodoTest {
    @ClassRule
    public static TestServer server = TestServer.getInstance();

    static final Logger logger = LoggerFactory.getLogger(DeleteTodo.class);

    @Test
    public void testDeleteTodo() throws ClientException, ApiException {
        CloseableHttpClient client = Client.getInstance().getSyncClient();
        HttpPost httpPost = new HttpPost(&quot;http://localhost:8080/api/json&quot;);
        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;host&quot;, &quot;lightapi.net&quot;);
        map.put(&quot;service&quot;, &quot;todo&quot;);
        map.put(&quot;action&quot;, &quot;delete&quot;);
        map.put(&quot;version&quot;, &quot;0.1.0&quot;);
        map.put(&quot;id&quot;, &quot;101010&quot;);

        JSONObject json = new JSONObject();
        json.putAll( map );
        System.out.printf( &quot;JSON: %s&quot;, json.toString() );


        try {
            httpPost.setEntity(new StringEntity(json.toString()));
            httpPost.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
            CloseableHttpResponse response = client.execute(httpPost);
            Assert.assertEquals(200, response.getStatusLine().getStatusCode());
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
</code></pre>

<pre><code class="language-java">package com.networknt.todolist.command.handler;

import com.networknt.client.Client;
import com.networknt.server.Server;
import com.networknt.exception.ClientException;
import com.networknt.exception.ApiException;
import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.*;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.jose4j.json.internal.json_simple.JSONObject;
import org.junit.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class UpdateTodoTest {
    @ClassRule
    public static TestServer server = TestServer.getInstance();

    static final Logger logger = LoggerFactory.getLogger(UpdateTodo.class);

    @Test
    public void testUpdateTodo() throws ClientException, ApiException {
        CloseableHttpClient client = Client.getInstance().getSyncClient();
        HttpPost httpPost = new HttpPost(&quot;http://localhost:8080/api/json&quot;);

        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;host&quot;, &quot;lightapi.net&quot;);
        map.put(&quot;service&quot;, &quot;todo&quot;);
        map.put(&quot;action&quot;, &quot;update&quot;);
        map.put(&quot;version&quot;, &quot;0.1.0&quot;);
        map.put(&quot;id&quot;, &quot;101010&quot;);
        map.put(&quot;title&quot;, &quot;create todo from hybrid service unit test&quot;);
        map.put(&quot;completed&quot;, false);
        map.put(&quot;order&quot;, 1);
        JSONObject json = new JSONObject();
        json.putAll( map );
        System.out.printf( &quot;JSON: %s&quot;, json.toString() );


        //Client.getInstance().addAuthorization(httpPost);
        try {
            httpPost.setEntity(new StringEntity(json.toString()));
            httpPost.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
            CloseableHttpResponse response = client.execute(httpPost);
            Assert.assertEquals(200, response.getStatusLine().getStatusCode());

        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
</code></pre>

<p>In order to make the test case works, we need to add a service.yml in
src/test/resources/config folder</p>

<pre><code class="language-yaml">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: org.h2.jdbcx.JdbcDataSource
      jdbcUrl: jdbc:h2:~/test
      username: sa
      password: sa
- com.networknt.eventuate.common.impl.sync.AggregateCrud:
    - com.networknt.eventuate.test.jdbc.EventuateEmbeddedTestAggregateStore
- com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.client.EventuateLocalAggregatesEvents
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate

</code></pre>

<p>Before running the tests, we need to add the following test dependencies into
pom.xml</p>

<pre><code class="language-xml">        &lt;version.hikaricp&gt;2.5.1&lt;/version.hikaricp&gt;
        &lt;version.h2&gt;1.3.176&lt;/version.h2&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;
            &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;
            &lt;version&gt;${version.hikaricp}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Test Dependencies --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;${version.h2}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

</code></pre>

<p>Now you can build the entire project from root folder of todo-list</p>

<pre><code>mvn clean install
</code></pre>

<h2 id="query-side-hybrid-service">Query side hybrid service</h2>

<p>To create query side hybrid service, we are going to use light-codegen to generate
the project in todo-list. Before generating the project, we need to create a config.json
to control how generator works and a schema.json to define the service contract.</p>

<p>These two files can be found in model-config/hybrid/todo-query folder.</p>

<p>config.json</p>

<pre><code class="language-json">{
  &quot;rootPackage&quot;: &quot;com.networknt.todolist.query&quot;,
  &quot;handlerPackage&quot;:&quot;com.networknt.todolist.query.handler&quot;,
  &quot;modelPackage&quot;:&quot;com.networknt.todolist.query.model&quot;,
  &quot;artifactId&quot;: &quot;hybrid-query&quot;,
  &quot;groupId&quot;: &quot;com.networknt&quot;,
  &quot;name&quot;: &quot;hybrid-query&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;overwriteHandler&quot;: true,
  &quot;overwriteHandlerTest&quot;: true
}
</code></pre>

<p>schema.json</p>

<pre><code class="language-json">{
  &quot;host&quot;: &quot;lightapi.net&quot;,
  &quot;service&quot;: &quot;todo&quot;,
  &quot;action&quot;: [
 {
    &quot;name&quot;: &quot;gettodo&quot;,
    &quot;version&quot;: &quot;0.1.0&quot;,
    &quot;handler&quot;: &quot;GetTodoById&quot;,
    &quot;scope&quot; : &quot;todo.r&quot;, 
    &quot;schema&quot; : {
      &quot;title&quot; : &quot;Service&quot;,
      &quot;type&quot; : &quot;object&quot;,
      &quot;properties&quot; : {
        &quot;id&quot; : {
          &quot;type&quot; : &quot;string&quot;
        }
      },
      &quot;required&quot; : [ &quot;id&quot; ]
    },
    &quot;scope&quot; : &quot;todo.r&quot;
  },
 {
     &quot;name&quot;: &quot;gettodos&quot;,
     &quot;version&quot;: &quot;0.1.0&quot;,
     &quot;handler&quot;: &quot;GetAllTodos&quot;,
    &quot;scope&quot; : &quot;todo.r&quot;, 
    &quot;schema&quot; : {
      &quot;title&quot; : &quot;Service&quot;
    },
    &quot;scope&quot; : &quot;todo.r&quot;
  }
  ]
}
</code></pre>

<p>Now let&rsquo;s run the light-codegen command line to generate the project.</p>

<pre><code>java -jar codegen-cli/target/codegen-cli.jar -f light-hybrid-4j-service -o ../light-example-4j/eventuate/todo-list/hybrid-query -m ../model-config/hybrid/todo-query/schema.json -c ../model-config/hybrid/todo-query/config.json
</code></pre>

<p>Let&rsquo;s add this newly generated project to the parent pom.xml and build all
modules.</p>

<pre><code class="language-xml">    &lt;modules&gt;
        &lt;module&gt;common&lt;/module&gt;
        &lt;module&gt;command&lt;/module&gt;
        &lt;module&gt;query&lt;/module&gt;
        &lt;module&gt;rest-command&lt;/module&gt;
        &lt;module&gt;rest-query&lt;/module&gt;
        &lt;module&gt;hybrid-command&lt;/module&gt;
        &lt;module&gt;hybrid-query&lt;/module&gt;
    &lt;/modules&gt;
</code></pre>

<pre><code class="language-xml">            &lt;dependency&gt;
                &lt;groupId&gt;com.networknt&lt;/groupId&gt;
                &lt;artifactId&gt;hybrid-query&lt;/artifactId&gt;
                &lt;version&gt;${project.version}&lt;/version&gt;
            &lt;/dependency&gt;

</code></pre>

<p>Rebuild all modules from root folder.</p>

<pre><code>mvn clean install

</code></pre>

<p>Now let&rsquo;s change the dependencies to add light-eventuate-4j modules and todo-list
modules.</p>

<pre><code class="language-xml">        &lt;version.light-eventuate-4j&gt;1.3.5&lt;/version.light-eventuate-4j&gt;

</code></pre>

<pre><code class="language-xml">        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-common&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;test-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-jdbc&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;eventuate-client&lt;/artifactId&gt;
            &lt;version&gt;${version.light-eventuate-4j}&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-common&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-command&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.networknt&lt;/groupId&gt;
            &lt;artifactId&gt;todo-query&lt;/artifactId&gt;
            &lt;version&gt;0.1.0&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre>

<p>With all the dependencies are added, let&rsquo;s change the handler to wire in the
right logic.</p>

<pre><code class="language-java">package com.networknt.todolist.query.handler;

import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import com.networknt.utility.NioUtils;
import com.networknt.rpc.Handler;
import com.networknt.rpc.router.ServiceHandler;
import java.nio.ByteBuffer;
import java.util.List;
import java.util.Map;

@ServiceHandler(id=&quot;lightapi.net/todo/gettodos/0.1.0&quot;)
public class GetAllTodos implements Handler {
    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    @Override
    public ByteBuffer handle(Object input)  {

        List&lt;Map&lt;String, TodoInfo&gt;&gt; resultAll = service.getAll();
        String returnMessage = null;
        try {
            returnMessage = Config.getInstance().getMapper().writeValueAsString(resultAll);
        } catch ( Exception e) {

        }
        return NioUtils.toByteBuffer(&quot;{\&quot;message\&quot;:&quot; +returnMessage + &quot;}&quot;);

    }
}

</code></pre>

<pre><code class="language-java">package com.networknt.todolist.query.handler;

import com.fasterxml.jackson.databind.JsonNode;
import com.networknt.config.Config;
import com.networknt.eventuate.todolist.TodoQueryService;
import com.networknt.eventuate.todolist.common.model.TodoInfo;
import com.networknt.service.SingletonServiceFactory;
import com.networknt.utility.NioUtils;
import com.networknt.rpc.Handler;
import com.networknt.rpc.router.ServiceHandler;
import java.nio.ByteBuffer;
import java.util.Map;
import java.util.concurrent.CompletableFuture;

@ServiceHandler(id=&quot;lightapi.net/todo/gettodo/0.1.0&quot;)
public class GetTodoById implements Handler {
    TodoQueryService service =
            (TodoQueryService) SingletonServiceFactory.getBean(TodoQueryService.class);

    @Override
    public ByteBuffer handle(Object input) {

        JsonNode inputPara = Config.getInstance().getMapper().valueToTree(input);

        String id = inputPara.findPath(&quot;id&quot;).asText();


        CompletableFuture&lt;Map&lt;String, TodoInfo&gt;&gt; result = service.findById(id);
        String returnMessage = null;
        try {
            returnMessage = Config.getInstance().getMapper().writeValueAsString(result);
        } catch (Exception e) {

        }
        return NioUtils.toByteBuffer(&quot;{\&quot;message\&quot;:&quot; + returnMessage + &quot;}&quot;);
    }
}

</code></pre>

<p>As we have to put the service jar into the hybrid server platform in order to run
it, we cannot wait then to test it. So for hybrid service development, end-to-end
test is very important to ensure what you have built is working.</p>

<p>Here are the two tests.</p>

<pre><code class="language-java">package com.networknt.todolist.query.handler;

import com.networknt.client.Client;
import com.networknt.server.Server;
import com.networknt.exception.ClientException;
import com.networknt.exception.ApiException;
import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.*;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.jose4j.json.internal.json_simple.JSONObject;
import org.junit.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class GetAllTodosTest {
    @ClassRule
    public static TestServer server = TestServer.getInstance();

    static final Logger logger = LoggerFactory.getLogger(GetAllTodos.class);

    @Test
    public void testGetAllTodos() throws ClientException, ApiException {
        CloseableHttpClient client = Client.getInstance().getSyncClient();
        HttpPost httpPost = new HttpPost(&quot;http://localhost:8082/api/json&quot;);
        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;host&quot;, &quot;lightapi.net&quot;);
        map.put(&quot;service&quot;, &quot;todo&quot;);
        map.put(&quot;action&quot;, &quot;gettodos&quot;);
        map.put(&quot;version&quot;, &quot;0.1.0&quot;);

        JSONObject json = new JSONObject();
        json.putAll( map );
        System.out.printf( &quot;JSON: %s&quot;, json.toString() );
        //Client.getInstance().addAuthorization(httpPost);
        try {
            httpPost.setEntity(new StringEntity(json.toString()));
            httpPost.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
            CloseableHttpResponse response = client.execute(httpPost);
            Assert.assertEquals(200, response.getStatusLine().getStatusCode());
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
</code></pre>

<pre><code class="language-java">package com.networknt.todolist.query.handler;

import com.networknt.client.Client;
import com.networknt.server.Server;
import com.networknt.exception.ClientException;
import com.networknt.exception.ApiException;
import org.apache.commons.io.IOUtils;
import org.apache.http.HttpResponse;
import org.apache.http.client.ClientProtocolException;
import org.apache.http.client.ResponseHandler;
import org.apache.http.client.methods.*;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.jose4j.json.internal.json_simple.JSONObject;
import org.junit.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

public class GetTodoByIdTest {
    @ClassRule
    public static TestServer server = TestServer.getInstance();

    static final Logger logger = LoggerFactory.getLogger(GetTodoById.class);

    @Test
    public void testGetTodoById() throws ClientException, ApiException {
        CloseableHttpClient client = Client.getInstance().getSyncClient();
        HttpPost httpPost = new HttpPost(&quot;http://localhost:8082/api/json&quot;);
        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();
        map.put(&quot;host&quot;, &quot;lightapi.net&quot;);
        map.put(&quot;service&quot;, &quot;todo&quot;);
        map.put(&quot;action&quot;, &quot;gettodo&quot;);
        map.put(&quot;version&quot;, &quot;0.1.0&quot;);
        map.put(&quot;id&quot;, &quot;101010&quot;);

        JSONObject json = new JSONObject();
        json.putAll( map );
        System.out.printf( &quot;JSON: %s&quot;, json.toString() );

        try {
            httpPost.setEntity(new StringEntity(json.toString()));
            httpPost.setHeader(&quot;Content-type&quot;, &quot;application/json&quot;);
            CloseableHttpResponse response = client.execute(httpPost);
            Assert.assertEquals(200, response.getStatusLine().getStatusCode());
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
}
</code></pre>

<p>The test server will load some light-eventuate-4j classes and H2 database and it
is defined in service.yml in src/test/resources/config folder.</p>

<pre><code class="language-yaml">singletons:
- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: org.h2.jdbcx.JdbcDataSource
      jdbcUrl: jdbc:h2:~/test
      username: sa
      password: sa
- com.networknt.eventuate.common.impl.sync.AggregateCrud,com.networknt.eventuate.common.impl.sync.AggregateEvents:
    - com.networknt.eventuate.test.jdbc.EventuateEmbeddedTestAggregateStore
- com.networknt.eventuate.common.impl.AggregateCrud:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateCrudAdapter
- com.networknt.eventuate.common.impl.AggregateEvents:
  - com.networknt.eventuate.common.impl.adapters.SyncToAsyncAggregateEventsAdapter
- com.networknt.eventuate.common.SnapshotManager:
  - com.networknt.eventuate.common.SnapshotManagerImpl
- com.networknt.eventuate.common.MissingApplyEventMethodStrategy:
  - com.networknt.eventuate.common.DefaultMissingApplyEventMethodStrategy
- com.networknt.eventuate.common.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.EventuateAggregateStoreImpl
- com.networknt.eventuate.common.sync.EventuateAggregateStore:
  - com.networknt.eventuate.common.impl.sync.EventuateAggregateStoreImpl
- com.networknt.eventuate.todolist.domain.TodoAggregate:
  - com.networknt.eventuate.todolist.domain.TodoAggregate
- com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate:
  - com.networknt.eventuate.todolist.domain.TodoBulkDeleteAggregate
- com.networknt.eventuate.todolist.TodoQueryRepository:
  - com.networknt.eventuate.todolist.TodoQueryRepositoryImpl
- com.networknt.eventuate.todolist.TodoQueryService:
  - com.networknt.eventuate.todolist.TodoQueryServiceImpl
- com.networknt.eventuate.todolist.TodoQueryWorkflow:
  - com.networknt.eventuate.todolist.TodoQueryWorkflow
- com.networknt.eventuate.event.EventHandlerProcessor:
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningVoid
  - com.networknt.eventuate.event.EventHandlerProcessorDispatchedEventReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningCompletableFuture
  - com.networknt.eventuate.event.EventHandlerProcessorEventHandlerContextReturningVoid
- com.networknt.eventuate.client.SubscriptionsRegistry:
  - com.networknt.eventuate.client.SubscriptionsRegistryImpl

</code></pre>

<p>Before running the tests, we need to add the following test dependencies into
pom.xml</p>

<pre><code class="language-xml">        &lt;version.hikaricp&gt;2.5.1&lt;/version.hikaricp&gt;
        &lt;version.h2&gt;1.3.176&lt;/version.h2&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;
            &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;
            &lt;version&gt;${version.hikaricp}&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;!-- Test Dependencies --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;version&gt;${version.h2}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

</code></pre>

<p>Now you can build the entire project from root folder of todo-list</p>

<pre><code>mvn clean install
</code></pre>

<h2 id="test-hybrid-services">Test hybrid services</h2>

<p>We will start hybrid-command server and hybrid-query server manually first and
then start them together along with services in a docker-compose.</p>

<p>The first step is to make sure light-eventuate-4j platform is up and running.
There is no need to start cdc-server though. Please follow this <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/">tutorial</a></p>

<p>To start hybrid servers manually, we need to checkout light-eventuate-4j as these
two servers are part of it.</p>

<pre><code>cd ~/networknt
git clone git@github.com:networknt/light-eventuate-4j.git
cd light-eventuate-4j
mvn clean install
</code></pre>

<p>Next let&rsquo;s start hybrid-command server with cdc-service and todo-list hybrid-command
service.</p>

<p>As there are more jars that need to be on the classpath of hybrid-command server
we are going to copy all of them into light-docker/</p>

<pre><code>cd ~/networknt/light-docker/eventuate/hybrid-command/service
cp ~/networknt/light-eventuate-4j/cdc-service/target/cdc-service-1.3.5.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/common/target/todo-common-0.1.0.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/command/target/todo-command-0.1.0.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/hybrid-command/target/hybrid-command-0.1.0.jar .
</code></pre>

<pre><code>cd ~/networknt/light-eventuate-4j/hybrid-command
java -cp ~/networknt/light-docker/eventuate/hybrid-command/service/*:target/hybrid-command-1.3.5.jar com.networknt.server.Server

</code></pre>

<p>Next let&rsquo;s start hybrid-query server with todo-list hybrid-query
service.</p>

<p>As there are more jars that need to be on the classpath of hybrid-query server
we are going to copy all of them into light-docker/</p>

<pre><code>cd ~/networknt/light-docker/eventuate/hybrid-query/service
cp ~/networknt/light-example-4j/eventuate/todo-list/common/target/todo-common-0.1.0.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/command/target/todo-command-0.1.0.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/query/target/todo-query-0.1.0.jar .
cp ~/networknt/light-example-4j/eventuate/todo-list/hybrid-query/target/hybrid-query-0.1.0.jar .
</code></pre>

<pre><code>cd ~/networknt/light-eventuate-4j/hybrid-query
java -cp ~/networknt/light-docker/eventuate/hybrid-query/service/*:target/hybrid-query-1.3.5.jar com.networknt.server.Server

</code></pre>

<p>Now let&rsquo;s create a todo item on command service with the following command.</p>

<pre><code>curl -X POST \
  http://localhost:8083/api/json \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -H 'postman-token: a9a7dd04-c621-7f83-a92c-33cc69e1b5ac' \
  -d '{&quot;host&quot;:&quot;lightapi.net&quot;,&quot;service&quot;:&quot;todo&quot;,&quot;action&quot;:&quot;create&quot;, &quot;version&quot;: &quot;0.1.0&quot;, &quot;title&quot;: &quot;create todo item from hybrid-command&quot;, &quot;completed&quot;: false, &quot;order&quot;: 1}'
</code></pre>

<p>Let&rsquo;s get all the todo items from query service with the following command</p>

<pre><code>curl -X POST \
  http://localhost:8082/api/json \
  -H 'cache-control: no-cache' \
  -H 'content-type: application/json' \
  -H 'postman-token: e797a185-5e5d-2c22-6001-98629303bcbb' \
  -d '{&quot;host&quot;:&quot;lightapi.net&quot;,&quot;service&quot;:&quot;todo&quot;,&quot;action&quot;:&quot;gettodos&quot;, &quot;version&quot;: &quot;0.1.0&quot;}'
</code></pre>

<h2 id="dockerization">Dockerization</h2>

<p>Let&rsquo;s copy docker config folder to the todo-list folder from existing
one.</p>

<ul>
<li>docker  contains docker config files</li>
</ul>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list
cp -r ../todo-list.bak/docker .

</code></pre>

<p>There are two sub-folders in the docker module:</p>

<p>\command-service      &ndash; command side config, include service.yml file</p>

<p>Since the service runs in the docker container, we need change the mysql host name to use docker image name:</p>

<p>service.yml:</p>

<pre><code class="language-yaml">- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://mysql:3306/eventuate?useSSL=false
      username: mysqluser
      password: mysqlpw

</code></pre>

<p>\query-service        &ndash; query side config, include service.yml and kafka.yml file</p>

<p>Since the service runs in the docker container, we need change the mysql host name and kafka host name to use docker image name:</p>

<p>service.yml:</p>

<pre><code class="language-yaml">- javax.sql.DataSource:
  - com.zaxxer.hikari.HikariDataSource:
      DriverClassName: com.mysql.jdbc.Driver
      jdbcUrl: jdbc:mysql://mysql:3306/todo_db?useSSL=false
      username: mysqluser
      password: mysqlpw

</code></pre>

<p>kafka.yml:</p>

<pre><code class="language-yaml">bootstrapServers: kafka:9092

</code></pre>

<h2 id="start-command-side-and-query-side-service-from-docker-compose">Start command side and query side service from docker compose</h2>

<p>Instead of start service from command line, start service from docker compose file:</p>

<pre><code>cd ~/networknt/light-example-4j/eventuate/todo-list
docker-compose up

</code></pre>

<p>Then following same steps above to verify the service result from command line</p>


			<aside class="copyright" role="note">
				
				&copy; 2017 Released under the MIT license &ndash;
				
				Documentation built with
				<a href="https://www.gohugo.io" target="_blank">Hugo</a>
				using the
				<a href="http://github.com/digitalcraftsman/hugo-material-docs" target="_blank">Material</a> theme.
			</aside>

			<footer class="footer">
				

<nav class="pagination" aria-label="Footer">
  <div class="previous">
  
      <a href="https://networknt.github.io/light-eventuate-4j/tutorial/kafka/" title="Debugging Kafka">
        <span class="direction">
          Previous
        </span>
        <div class="page">
          <div class="button button-previous" role="button" aria-label="Previous">
            <i class="icon icon-back"></i>
          </div>
          <div class="stretch">
            <div class="title">
              Debugging Kafka
            </div>
          </div>
        </div>
      </a>
  
  </div>

  <div class="next">
  
      <a href="https://networknt.github.io/light-eventuate-4j/tutorial/service-dev/" title="Workspace setup for developing light-eventuate-4j services">
        <span class="direction">
          Next
        </span>
        <div class="page">
          <div class="stretch">
            <div class="title">
              Workspace setup for developing light-eventuate-4j services
            </div>
          </div>
          <div class="button button-next" role="button" aria-label="Next">
            <i class="icon icon-forward"></i>
          </div>
        </div>
      </a>
  
  </div>
</nav>





			</footer>
		</div>
	</article>

	<div class="results" role="status" aria-live="polite">
		<div class="scrollable">
			<div class="wrapper">
				<div class="meta"></div>
				<div class="list"></div>
			</div>
		</div>
	</div>
</main>

    <script>
    
      var base_url = 'https:\/\/networknt.github.io\/light-eventuate-4j';
      var repo_id  = 'networknt\/light-eventuate-4j';
    
    </script>

    <script src="https://networknt.github.io/light-eventuate-4j/javascripts/application.js"></script>
    

    <script>
      /* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }
    </script>

    

    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>

